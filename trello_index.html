<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Excel Card Importer</title>
  <link rel="stylesheet" href="https://p.trellocdn.com/power-up.min.css">
  <script src="https://p.trellocdn.com/power-up.min.js"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      padding: 20px;
      background: #f4f5f7;
      margin: 0;
    }
    .container {
      max-width: 700px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.12);
    }
    h1 {
      color: #172b4d;
      margin-top: 0;
      font-size: 24px;
    }
    h3 {
      color: #172b4d;
      margin: 25px 0 15px 0;
      font-size: 16px;
    }
    .upload-area {
      border: 2px dashed #dfe1e6;
      border-radius: 8px;
      padding: 40px;
      text-align: center;
      margin: 20px 0;
      cursor: pointer;
      transition: all 0.2s;
    }
    .upload-area:hover {
      border-color: #0079bf;
      background: #f9fafc;
    }
    .upload-area.dragover {
      border-color: #0079bf;
      background: #e6f4ff;
    }
    input[type="file"] {
      display: none;
    }
    .btn {
      background: #0079bf;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: background 0.2s;
    }
    .btn:hover {
      background: #026aa7;
    }
    .btn:disabled {
      background: #dfe1e6;
      cursor: not-allowed;
    }
    .btn-small {
      padding: 6px 12px;
      font-size: 12px;
    }
    .mapping-section {
      margin: 20px 0;
      display: none;
    }
    .field-mapping {
      background: #f4f5f7;
      padding: 20px;
      border-radius: 6px;
      margin-bottom: 15px;
    }
    .field-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .field-label {
      font-weight: 600;
      color: #172b4d;
      font-size: 14px;
    }
    .mode-switch {
      display: flex;
      gap: 5px;
    }
    .mode-btn {
      padding: 4px 10px;
      font-size: 12px;
      border: 1px solid #dfe1e6;
      background: white;
      border-radius: 3px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .mode-btn.active {
      background: #0079bf;
      color: white;
      border-color: #0079bf;
    }
    .simple-mode, .template-mode {
      display: none;
    }
    .simple-mode.active, .template-mode.active {
      display: block;
    }
    .simple-select {
      width: 100%;
      padding: 10px;
      border: 1px solid #dfe1e6;
      border-radius: 4px;
      font-size: 14px;
      margin-top: 8px;
    }
    .template-input {
      width: 100%;
      padding: 10px;
      border: 1px solid #dfe1e6;
      border-radius: 4px;
      font-size: 13px;
      font-family: 'Courier New', monospace;
      margin-top: 8px;
      min-height: 60px;
      resize: vertical;
    }
    .column-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 8px;
    }
    .chip {
      background: #0079bf;
      color: white;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
    }
    .chip:hover {
      background: #026aa7;
      transform: translateY(-1px);
    }
    .template-help {
      font-size: 12px;
      color: #5e6c84;
      margin-top: 5px;
      padding: 8px;
      background: #fff;
      border-radius: 3px;
    }
    .template-help code {
      background: #f4f5f7;
      padding: 2px 5px;
      border-radius: 3px;
      font-size: 11px;
    }
    .list-selector {
      margin: 20px 0;
    }
    .list-selector label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #172b4d;
    }
    .list-selector select {
      width: 100%;
      padding: 10px;
      border: 1px solid #dfe1e6;
      border-radius: 4px;
      font-size: 14px;
    }
    .progress {
      margin: 20px 0;
      display: none;
    }
    .progress-bar {
      height: 8px;
      background: #dfe1e6;
      border-radius: 4px;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      background: #0079bf;
      width: 0%;
      transition: width 0.3s;
    }
    .status {
      margin-top: 10px;
      color: #5e6c84;
      font-size: 14px;
    }
    .instructions {
      background: #f4f5f7;
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 20px;
      font-size: 14px;
      color: #172b4d;
    }
    .instructions strong {
      display: block;
      margin-bottom: 5px;
    }
    .preview-section {
      margin: 20px 0;
      display: none;
    }
    .preview-card {
      background: white;
      border: 1px solid #dfe1e6;
      border-radius: 6px;
      padding: 15px;
      margin-bottom: 10px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    .preview-card-name {
      font-weight: 600;
      color: #172b4d;
      margin-bottom: 8px;
    }
    .preview-card-desc {
      color: #5e6c84;
      font-size: 13px;
      white-space: pre-wrap;
    }
    .preview-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üìä Excel Card Importer</h1>
    
    <div class="instructions">
      <strong>How to use:</strong>
      1. Upload an Excel file (.xlsx or .xls)<br>
      2. Map columns to card fields (Simple or Template mode)<br>
      3. Preview your cards<br>
      4. Select the target list and import
    </div>

    <div class="upload-area" id="uploadArea">
      <p>üìÅ Drop Excel file here or click to browse</p>
      <input type="file" id="fileInput" accept=".xlsx,.xls">
    </div>

    <div class="mapping-section" id="mappingSection">
      <h3>Field Mapping</h3>

      <!-- Card Name -->
      <div class="field-mapping">
        <div class="field-header">
          <span class="field-label">Card Name *</span>
          <div class="mode-switch">
            <button class="mode-btn active" data-field="name" data-mode="simple">Simple</button>
            <button class="mode-btn" data-field="name" data-mode="template">Template</button>
          </div>
        </div>
        <div class="simple-mode active" id="nameSimple">
          <select class="simple-select" id="nameColumn">
            <option value="">-- Select Column --</option>
          </select>
        </div>
        <div class="template-mode" id="nameTemplate">
          <textarea class="template-input" id="nameTemplateInput" placeholder='Example: %Title + " - " + %Status'></textarea>
          <div class="column-chips" id="nameChips"></div>
          <div class="template-help">
            Click column names to insert. Use <code>+</code> to concatenate, <code>"\n"</code> for new line, <code>" "</code> for text.
          </div>
        </div>
      </div>

      <!-- Description -->
      <div class="field-mapping">
        <div class="field-header">
          <span class="field-label">Description</span>
          <div class="mode-switch">
            <button class="mode-btn active" data-field="description" data-mode="simple">Simple</button>
            <button class="mode-btn" data-field="description" data-mode="template">Template</button>
          </div>
        </div>
        <div class="simple-mode active" id="descriptionSimple">
          <select class="simple-select" id="descriptionColumn">
            <option value="">-- None --</option>
          </select>
        </div>
        <div class="template-mode" id="descriptionTemplate">
          <textarea class="template-input" id="descriptionTemplateInput" placeholder='Example: "Details: " + %Notes + "\n" + "Priority: " + %Priority'></textarea>
          <div class="column-chips" id="descriptionChips"></div>
          <div class="template-help">
            Build complex descriptions by combining multiple columns
          </div>
        </div>
      </div>

      <!-- Due Date -->
      <div class="field-mapping">
        <div class="field-header">
          <span class="field-label">Due Date</span>
        </div>
        <div class="simple-mode active">
          <select class="simple-select" id="dueColumn">
            <option value="">-- None --</option>
          </select>
        </div>
      </div>

      <!-- Location -->
      <div class="field-mapping">
        <div class="field-header">
          <span class="field-label">Location</span>
          <div class="mode-switch">
            <button class="mode-btn active" data-field="location" data-mode="simple">Simple</button>
            <button class="mode-btn" data-field="location" data-mode="template">Template</button>
          </div>
        </div>
        <div class="simple-mode active" id="locationSimple">
          <select class="simple-select" id="locationColumn">
            <option value="">-- None --</option>
          </select>
        </div>
        <div class="template-mode" id="locationTemplate">
          <textarea class="template-input" id="locationTemplateInput" placeholder='Example: %City + ", " + %Country'></textarea>
          <div class="column-chips" id="locationChips"></div>
        </div>
      </div>

      <button class="btn" id="previewBtn" style="margin-top: 20px;">Preview Cards</button>
    </div>

    <div class="preview-section" id="previewSection">
      <div class="preview-header">
        <h3 style="margin: 0;">Preview (First 3 Cards)</h3>
        <button class="btn btn-small" id="editMappingBtn">Edit Mapping</button>
      </div>
      <div id="previewCards"></div>
    </div>

    <div class="list-selector" id="listSelector" style="display:none;">
      <label>Import to List:</label>
      <select id="targetList"></select>
    </div>

    <div class="progress" id="progress">
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
      <div class="status" id="status"></div>
    </div>

    <button class="btn" id="importBtn" style="display:none; width: 100%; margin-top: 20px;">Import All Cards</button>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
    let t = window.TrelloPowerUps.iframe();
    let excelData = null;
    let columnHeaders = [];
    let fieldModes = {
      name: 'simple',
      description: 'simple',
      location: 'simple'
    };

    // Initialize
    document.getElementById('uploadArea').addEventListener('click', () => {
      document.getElementById('fileInput').click();
    });

    document.getElementById('fileInput').addEventListener('change', handleFileSelect);

    // Drag and drop
    const uploadArea = document.getElementById('uploadArea');
    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('dragover');
    });
    uploadArea.addEventListener('dragleave', () => {
      uploadArea.classList.remove('dragover');
    });
    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      const file = e.dataTransfer.files[0];
      if (file) {
        processFile(file);
      }
    });

    // Mode switching
    document.addEventListener('click', (e) => {
      if (e.target.classList.contains('mode-btn')) {
        const field = e.target.dataset.field;
        const mode = e.target.dataset.mode;
        
        // Update button states
        e.target.parentElement.querySelectorAll('.mode-btn').forEach(btn => {
          btn.classList.remove('active');
        });
        e.target.classList.add('active');
        
        // Update mode displays
        const parent = e.target.closest('.field-mapping');
        parent.querySelectorAll('.simple-mode, .template-mode').forEach(el => {
          el.classList.remove('active');
        });
        parent.querySelector(`.${mode}-mode`).classList.add('active');
        
        fieldModes[field] = mode;
      }
    });

    // Preview button
    document.getElementById('previewBtn').addEventListener('click', generatePreview);
    document.getElementById('editMappingBtn').addEventListener('click', () => {
      document.getElementById('previewSection').style.display = 'none';
      document.getElementById('mappingSection').style.display = 'block';
      document.getElementById('listSelector').style.display = 'none';
      document.getElementById('importBtn').style.display = 'none';
    });

    // Import button
    document.getElementById('importBtn').addEventListener('click', importCards);

    function handleFileSelect(e) {
      const file = e.target.files[0];
      if (file) {
        processFile(file);
      }
    }

    function processFile(file) {
      const reader = new FileReader();
      
      reader.onload = function(e) {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
          const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
          
          if (jsonData.length < 2) {
            alert('Excel file must have at least a header row and one data row');
            return;
          }
          
          columnHeaders = jsonData[0];
          excelData = jsonData.slice(1).filter(row => row.length > 0);
          
          setupMappingUI();
          
        } catch (error) {
          alert('Error reading Excel file: ' + error.message);
        }
      };
      
      reader.readAsArrayBuffer(file);
    }

    function setupMappingUI() {
      const selects = ['nameColumn', 'descriptionColumn', 'dueColumn', 'locationColumn'];
      
      selects.forEach(selectId => {
        const select = document.getElementById(selectId);
        select.innerHTML = selectId === 'nameColumn' ? '<option value="">-- Select Column --</option>' : '<option value="">-- None --</option>';
        
        columnHeaders.forEach((header, index) => {
          const option = document.createElement('option');
          option.value = index;
          option.textContent = header;
          select.appendChild(option);
        });
        
        if (selectId === 'nameColumn' && columnHeaders.length > 0) {
          select.value = 0;
        }
      });

      // Setup column chips for templates
      ['name', 'description', 'location'].forEach(field => {
        const chipsContainer = document.getElementById(`${field}Chips`);
        chipsContainer.innerHTML = '';
        
        columnHeaders.forEach((header, index) => {
          const chip = document.createElement('button');
          chip.className = 'chip';
          chip.textContent = header;
          chip.onclick = () => insertColumnReference(field, header);
          chipsContainer.appendChild(chip);
        });
      });
      
      document.getElementById('mappingSection').style.display = 'block';
    }

    function insertColumnReference(field, columnName) {
      const textarea = document.getElementById(`${field}TemplateInput`);
      const cursorPos = textarea.selectionStart;
      const textBefore = textarea.value.substring(0, cursorPos);
      const textAfter = textarea.value.substring(cursorPos);
      
      textarea.value = textBefore + `%${columnName}` + textAfter;
      textarea.focus();
      textarea.selectionStart = textarea.selectionEnd = cursorPos + columnName.length + 1;
    }

    function parseTemplate(template, row) {
      if (!template) return '';
      
      let result = template;
      
      // Replace column references
      columnHeaders.forEach((header, index) => {
        const value = row[index] || '';
        result = result.replace(new RegExp(`%${header.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}`, 'g'), value);
      });
      
      // Handle string literals and concatenation
      try {
        // Replace "\n" with actual newlines
        result = result.replace(/\\n/g, '\n');
        
        // Remove + operators and quotes for evaluation
        result = result.split('+').map(part => {
          part = part.trim();
          if (part.startsWith('"') && part.endsWith('"')) {
            return part.slice(1, -1);
          }
          return part;
        }).join('');
        
      } catch (error) {
        console.error('Template parsing error:', error);
      }
      
      return result.trim();
    }

    function getFieldValue(field, row) {
      if (fieldModes[field] === 'template') {
        const template = document.getElementById(`${field}TemplateInput`).value;
        return parseTemplate(template, row);
      } else {
        const colIndex = document.getElementById(`${field}Column`).value;
        return colIndex !== '' ? (row[colIndex] || '') : '';
      }
    }

    function generatePreview() {
      const nameValue = fieldModes.name === 'simple' 
        ? document.getElementById('nameColumn').value
        : document.getElementById('nameTemplateInput').value;

      if (!nameValue) {
        alert('Please configure Card Name field');
        return;
      }

      const previewCards = document.getElementById('previewCards');
      previewCards.innerHTML = '';

      const previewData = excelData.slice(0, 3);
      
      previewData.forEach((row, index) => {
        const cardDiv = document.createElement('div');
        cardDiv.className = 'preview-card';
        
        const name = getFieldValue('name', row) || 'Untitled';
        const desc = getFieldValue('description', row);
        const location = getFieldValue('location', row);
        
        let descriptionText = desc;
        if (location) {
          descriptionText += (descriptionText ? '\n\n' : '') + `üìç Location: ${location}`;
        }
        
        cardDiv.innerHTML = `
          <div class="preview-card-name">${name}</div>
          ${descriptionText ? `<div class="preview-card-desc">${descriptionText}</div>` : ''}
        `;
        
        previewCards.appendChild(cardDiv);
      });

      document.getElementById('mappingSection').style.display = 'none';
      document.getElementById('previewSection').style.display = 'block';
      
      loadLists();
    }

    async function loadLists() {
      try {
        const lists = await t.lists('all');
        const select = document.getElementById('targetList');
        
        select.innerHTML = '';
        lists.forEach(list => {
          const option = document.createElement('option');
          option.value = list.id;
          option.textContent = list.name;
          select.appendChild(option);
        });
        
        document.getElementById('listSelector').style.display = 'block';
        document.getElementById('importBtn').style.display = 'block';
      } catch (error) {
        alert('Error loading lists: ' + error.message);
      }
    }

    async function importCards() {
      const targetListId = document.getElementById('targetList').value;
      
      document.getElementById('progress').style.display = 'block';
      document.getElementById('importBtn').disabled = true;
      
      const progressFill = document.getElementById('progressFill');
      const status = document.getElementById('status');
      
      let created = 0;
      const total = excelData.length;
      
      for (let i = 0; i < excelData.length; i++) {
        const row = excelData[i];
        
        const name = getFieldValue('name', row) || 'Untitled';
        const description = getFieldValue('description', row);
        const location = getFieldValue('location', row);
        const dueCol = document.getElementById('dueColumn').value;
        
        const cardData = {
          name: name,
          desc: description,
          idList: targetListId
        };

        if (location) {
          cardData.coordinates = location;
        }
        
        if (dueCol && row[dueCol]) {
          const dueDate = parseDate(row[dueCol]);
          if (dueDate) {
            cardData.due = dueDate.toISOString();
          }
        }
        
        try {
          await t.card('create', cardData);
          created++;
          
          const progress = (created / total) * 100;
          progressFill.style.width = progress + '%';
          status.textContent = `Created ${created} of ${total} cards...`;
          
        } catch (error) {
          console.error('Error creating card:', error);
        }
      }
      
      status.textContent = `‚úÖ Successfully imported ${created} cards!`;
      document.getElementById('importBtn').textContent = 'Done!';
      
      setTimeout(() => {
        t.closeModal();
      }, 2000);
    }

    function parseDate(dateValue) {
      if (!dateValue) return null;
      
      if (typeof dateValue === 'number') {
        const date = XLSX.SSF.parse_date_code(dateValue);
        return new Date(date.y, date.m - 1, date.d);
      }
      
      const parsed = new Date(dateValue);
      return isNaN(parsed.getTime()) ? null : parsed;
    }
  </script>
</body>
</html>